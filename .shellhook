#!/usr/bin/env bash

if [ "$(uname -s)" = "Darwin" ]; then
    alias ls="ls --color=auto"
    alias ll="ls -l"
else
    alias open="xdg-open"
fi

export WD=$PWD

if [ ! -d "$WD/out" ]; then
    mkdir "$WD/out"
fi

export ARGS=(
    -I "$BENCHMARK_CMA_PATH"
    -unboxed-types
    -w +1..66
)
export LIBS=(
    unix.cma
    benchmark.cma
)
export OCAMLRUNPARAM="a=0,c,o=80"

runo () {
    ocp-indent "$1" > tmp.ml
    if diff "$1" tmp.ml > /dev/null 2>&1; then
        rm tmp.ml
    else
        mv tmp.ml "$1"
    fi
    if [ -z "$2" ]; then
        ocaml "${ARGS[@]}" "${LIBS[@]}" "$1"
    else
        ocaml "${ARGS[@]}" "${LIBS[@]}" "$1" "$2"
    fi
}

export -f runo
